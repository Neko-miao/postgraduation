# 基于动画共享和LOD实现高效实时的大规模群体动画渲染  
## 摘要  
## Abstract  
## 图目录  
## 表目录  
## 第1章 绪论  
### 1.1 研究背景和意义  
- 大规模群体动画渲染的发展现状和应用领域；  
    大规模群体动画是图形学领域中的热门研究课题，它通过模拟和控制大规模群体中个体的行为，实现自然、逼真和适应性的动画效果，从鱼群、鸟群到人群、交通流等各种群体行为都可以通过大规模群体动画进行模拟和展示。随着计算机性能的提升和算法技术的不断进步，大规模群体动画的研究得到了飞跃的发展，大规模群体动画的实时性和真实感有了显著的提高。研究者们通过引入群体行为模型、仿真算法和先进的渲染技术（附加具体模型、算法或技术），不仅能够模拟复杂的群体行为，还能呈现出逼真的视觉效果。大规模群体动画的发展不仅推动了动画产业的发展，也为交通规划、生态环境模拟等领域提供了重要的参考和工具。在游戏领域，大规模群体动画往往能带来震撼的视觉效果，游戏开发者通过大规模群体动画可以创建更加生动的游戏场景和NPC角色，提升游戏的沉浸感和真实感。此外，利用大规模群体动画技术可以模拟呈现大规模战争、人群等场景，不仅减少了开发成本，为制作团提供更多的创作自由度，还为用户带来了更加真实和沉浸式的体验。  
- 说明大规模群体动画的关键问题；  
    大规模群体动画是图形学中具有挑战性的研究课题之一，其关键技术难点主要包括群体行为建模、群体智能和渲染技术等方面（应用引文）。群体行为建模需要设计合理的模型来描述个体之间的相互作用和群体整体的行为规律。群体智能需要通过算法和模拟方法实现个体之间的自适应和智能行为。渲染技术则需要解决大规模场景中的实时渲染和灯光效果等挑战。这些技术挑战需要研究者们通过创新和交叉学科合作来解决，从而推动大规模群体动画的进一步发展。
- 阐述当前实现大规模群体动画渲染的技术方案和对应的缺陷；
    - 说明研究重点和面临的问题
    本文研究的群体动画针对于骨骼动画，当前最通用的骨骼动画实现机制是在CPU端通过动画状态机的方式实现对动画的采样和混合，然后在CPU或GPU端对动画状态机输出的动画姿势进行蒙皮操作，最终将动画对象呈现在渲染画面中。这种机制实现的动画系统不仅可以非常精细的实现角色的动画，而且动画系统对动画状态分层以及动画叠加功能的支持，更是极大丰富了角色动画的多样性。但随着角色规模的扩大，该动画系统会面临以下问题。首先CPU端需要消耗大部分的性能来计算角色的动画姿势，其次，庞大角色的动画渲染也将面临巨大的压力。因此，本研究内容着重于改善大规模群体骨骼动画的性能并尽可能保留群体动画的多样性，最终在此基础上构建一套能够投入使用的大规模群体动画系统框架。
    - 说明加速大规模群体动画的一些解决方案  
    实现大规模群体动画的实时渲染是一项复杂的任务，需要在限定时间内渲染和处理大量的角色和动画数据，以下是一些常用的技术和方法来实现大规模群体动画的渲染。第一，LoD(Level of Detail)是其中最高效也是最常见的方法。所谓基于LoD的渲染就是根据某种条件为待渲染的模型选择合适复杂度和精度的几何表示，在渲染大量角色动画的场景中，可以根据每个角色实例对最终图像的影响力为该角色实例选择最合适的模型网格，评价图像影响力的因素有很多，最常用的就是根据渲染对象与场景摄像机之间距离。简单说，LoD技术之所以能够加速渲染，是因为它可以减少大量顶点和三角形的渲染工作，以最小的渲染质量损失换取了最大的渲染效率提升。第二，无损失渲染加速技术，包括剔除技术、实例化技术和伪实例化技术等等，这些技术相对LoD技术来说不会对渲染图像造成视觉损失。剔除是渲染阶段常用的技术手段，其作用就是丢弃那些不会被看到的模型对象的全部或者部分，常见的剔除方式有视锥体剔除、遮挡剔除等。实例化技术是一种在计算机图形学中常用的优化技术，通过将相同的模型实例化多次来进行批量渲染。即通过使用相同的渲染数据，但在不同的位置和姿态上实例化多个对象，而不是渲染每个对象的独立模型。这种技术利用了GPU并行处理的特点，可以大大减少渲染调用次数和数据传输的开销，提高渲染性能。伪实例化技术是一种类似实例化技术的优化技术，在某些情况下可以替代实例化技术来降低资源和渲染开销。它通过将多个对象的渲染数据合并成一个大的渲染数据块，并在渲染过程中通过索引和偏移量来实现对对象的渲染。
    - 阐述上述方案存在的缺陷  
    尽管以上所述的技术可以加速群体动画渲染，但也存在一定程度上的缺陷。首先，目前大多数应用都选择了离散型LoD方法，即在离线时生成多份模型网格不同简化程度的版本，并在实际渲染时应用一个适合的简化版本。这种离散型LoD方法确实可以简单高效地加快渲染进程，但是多份简化的模型网格必然会增加内存占用，而且由于不同简化程度的模型网格之间很难做平滑过渡，在大规模群体动画上应用离散型LoD会使得最终地渲染效果呈现出一种“弹出式”的视觉伪像，在相机由远及近（或由近及远）地快速运动时更为明显。其次，实例化技术在渲染静态物体方面有很好的效果，但在动画渲染方面有一些短板和局限。例如因为实例化的对象共享着相同的数据模型，因此很难单独对每个实例对象实现动画的混合和控制，这很有可能导致动画之间的过渡效果不连贯以及动画多样性的丢失。
- 基于以上问题初步提出本文系统架构并说明其中的意义；  
    基于以上问题，本文提出了一套高效率的GPU动画渲染框架，该框架包含视锥体剔除、动态网格的连续LoD选择、以及基于动画实例化技术的骨骼动画蒙皮和渲染，该框架充分利用了GPU强大的计算能力，高效利用GPU内存，实现了海量动画角色的实时渲染。而在CPU端，本文提出了一种基于动画状态共享的动画实现方案，既最大限度利用了现有的骨骼动画技术，保留了动画群体与群体模拟端（如群体中每个个体的决策系统、群体的寻路系统等）以及与用户端的复杂交互逻辑，又能减轻CPU端的计算压力，让CPU留有余力去处理应用中的其他模块或系统。
- 结合项目实践，再次说明本文的研究意义；

### 1.2 国内外研究现状  
#### 1.2.1 群体动画研究现状  
- 简单介绍群体动画模拟的研究现状，简要阐述群体动画渲染的几种方法，例如基于图像的渲染方法、动画实例化等等
群体动画的研究存在三大问题：群体建模、碰撞避免和路径规划。群体建模是指如何和构建具有高度复杂性、真实性和各种互动的群体模型；碰撞避免是指群体中的个体之间可能会相互接触，因此避免个体之间的碰撞是一个非常重要的问题；路径规划是指群体移动时每个个体都需要找到自己的路线，并且能让移动看起来更具群体性。

Reynolds在1987年最早发表了关于群体模拟的论文，这篇论文提出了一种基于物理学的仿真算法用于模拟群体动画，Reynolds观察到鸟群、鱼群等动物的行为规律并将其建模，提出了基于三个规则的群体动力学模型：分离、聚集和排列。该算法不仅可以用于简单的鸟群、鱼群模拟，还被广泛运用于复杂的智能体模拟，可以说Reynolds的算法对群体模拟做出了最基础的贡献，也影响了后来很多群体模拟算法的发展，该算法是群体模拟领域最具代表性的算法之一。无独有偶，Reynolds[2]在1999年又发表了一篇影响深远的论文，该论文提供了一种基于行为的控制方法，用于模拟群体动画的角色行为，并提出了一些基于行为摩的控制技术，包括避让、聚集和排列等。该方法在模拟智能体方面具有重要意义。Reynolds的算法通过描述行为的方式，可以使可控性变得更高，降低了模拟误差，并为后来的决策树、强化学习和机器学习等技术的发展奠定了基础。

Tu等人在1994年发表的论文中提出了一种仿生学方法，论文以智能鱼为研究对象，模拟了鱼类的运动、视觉感知和行为。智能鱼模型基于生物物理学模型，可以模型鱼在水中躲避障碍物、逃避天敌、自由进食、漫游求偶等行为，能有效模拟鱼群的群体生活。该论文的主要影响力在于提出了用仿生学来模拟个体的思想，这种思想在人工智能和机器学习等领域能得到很好的应用，也为群体行为仿真领域的研究做出了卓越的贡献。

Musse等人在2001年的发表的论文提出了一种层次模型，可以用于实时模拟虚拟人类群体，并能够在不同的解析度下进行模拟。该论文提出的算法在实时性和精确度之间找到了一个平衡点，在刻画虚拟人群行为的同时，保证资源的有效利用。该层次模型随后称为人群动画领域的一个标准，并得到广泛的应用。

Van等人在2008年发表的论文中提出了一种基于采样的动态路径规划算法，用于实现多个移动智能体在拥挤的环境中自主导航的任务。该算法的主要思想可以分为三个阶段：采样、最优化和回溯。其中采样阶段将环境划分为离散的空间状态，再用蒙特卡洛方法生成行动路径，以降低路径规划的复杂度。再最优化阶段，算法通过加入动力学限制，预测其他机器人的行动，并将生成的路径转化为单个机器人所需的轨迹。在回溯阶段，为了评估生成的路径并得到它们的优缺点，利用模拟退火解开优化问题，以确定轨迹的最优选数。该论文提出的基于采样的动态路径规划算法为群体智能体的路径规划提供了新的思路和方法，且算法可用于多个机器人之间的协作和规划，并可应用于复杂的群体运动环境，具有广泛的应用前景。
#### 1.2.2 大规模群体动画的实现方案  
当今天为止，已经有相当多优秀的论文讨论群体动画所面临的三大问题，但是在群体动画模拟中，还经常会涉及到大量的模型渲染，并且需要在实时性和精度之间找到一个平衡点。然而，随着人工智能算法的不断发展和新型游戏引擎的不断涌现，越来越多的渲染问题开始影响群体动画模拟的性能。

Rudomín等人在2005年的论文中提出了一种新的用于群体智能体的状态机动画技术，其中动画是由片段着色器生成的。这种技术不仅可以实现高效的可视化，同时还可以减少传统动画技术中计算和存储的开销。该算法的核心思想是使用智能体的状态编码为颜色的图像序列，每一种颜色对应一个特定状态，并利用GPU进行并行计算，直接在GPU中进行动画渲染。这样的话，系统无需存储每个智能体的轨迹和状态信息，降低了存储成本和计算成本，使得系统更加高效。该算法的优势在于它可以模拟高分辨率的环境，并且可以在极短的时间内产生逼真的效果。同时，对于一些实时性高、资源密集型的约束任务，该算法的应用也是具有显著优势的。

Park等人在2008年提出了一种快速渲染大规模模型的技术，该技术同样利用GPU强大的图形处理能力，提升了渲染效率和渲染质量。该论文提出的方案核心要点是尽可能让将更少的渲染工作留给CPU，而让GPU承担更多的工作。其算法第一阶段是先用AABB（Axis-aligned bounding box）包围待渲染的模型，并假定模型的位置就是AABB包围盒的中心，在渲染管线中，模型首先经过顶点着色器变换到裁剪空间，此时利用AABB包围盒可以较方便地将位于裁剪空间之外模型剔除掉，减轻后续渲染的工作量，再经过之后的几何着色器后模型顶点网格的LoD会由它在裁剪空间的深度决定，并被缓存下来，在Park等人的实现中其所采用的是离散LoD模型。接着，算法进入第二阶段，由第一阶段产生的离散LoDs缓存会被分类存储，即相同层级的LoD会被放在同一个Buffer中，而不是第一阶段在同一个Buffer中缓存所有LoD顶点，这样做的目的是为了组织GPU友好的数据结构，为后续模型的渲染提供遍历。最后，算法进入第三阶段，利用DirectX提供实例化技术[13]来渲染模型，该技术要求每次处理模型的分辨率是一致的，这也是第二阶段会对第一阶段的LoD缓存做分类处理的原因。

Sung在2018年也提出一种快速实时的群体动画模拟技术，这种技术是对Park等人的方案改进，利用GPU强大并行计算能力实时高效渲染由动作捕捉获取的数据。Sung的方案核心点在于分离CPU和GPU的工作，同时将静态数据（如模型的绑定姿势数据）和动态数据（如模型的实时骨骼和位置信息）分离。GPU的主要工作就是获取动画数据信息，同时CPU会执行群体的路径规划算法并实时更新模型动画的顶点信息。这些顶点信息会被打包成SSBO（Shader Storage Buffer Object），这是一种能加速渲染的的数据结构，当然除了模型的运动数据，其全局空间坐标也会在CPU实时更新，这是为了渲染出的模型能在正确的位置并朝着正确的方向。待CPU将所有数据处理完成并打包发送给GPU后，系统就可以在着色阶段根据SSBO缓存信息利用图形接口提供的实例化技术快速将模型正确地渲染出来，同时利用Phong光照模型为骨骼着色。Sung的实现中只处理了模型的骨骼信息，而没有处理模型的“皮肤”。

Paduraru在2017年提出了一种高效实现人群动画模拟的框架，该框架在不预存任何动画信息的前提下提高了人群动画的多样性和可用性，框架使用了一种高效实现CPU和GPU之间动画数据流动的方法，最后还提出一个新的技术用于实现人群中单个人物模型的动画融合。在Paduraru的实现中，动画数据被定义为动画流，动画流包含动画的骨骼和蒙皮顶点信息、动画的当前输出姿势、用于更新动画状态的动画控制器以及动画姿势缓存历史，该动画流由CPU驱动更新，通过动画控制器计算得到的当前模型姿势会被记录下来，供其他播放相同动画的不同模型共享。模型的动画流信息会被存储在一张图片上，图片的每一行存储了该动画流所包含的单个动画的某一帧所有骨骼的空间信息，不同的动画流会被存储在不同的图片缓存上，最终所有的动画流数据被打包并实时同步到GPU中，而GPU会用相似的结构来再把动画流信息存储一次。框架中的动画融合仍然在CPU端进行，与传统动画融合方案不同的时，系统会把融合后的动画姿势存储下来，当然这个信息也会同步给GPU端。最后，系统在GPU端根据ＣＰＵ同步过来的动画流信息渲染模型，这里包括模型的蒙皮计算和顶点的光照计算。

随后Paduraru等人在2022年提出一个新的大规模人群动画实现方案，这个方案时基于上述动画框架的改进，不仅可以节约CPU的存储空间，而且做了角色模块化处理，让角色动画的渲染更加灵活可控，同时可以在ＧＰＵ实现动画的融合操作。首先，新的方案放弃了在CPU中缓存动画流信息，而全交由ＧＰＵ端来缓存。模型不同部位的骨骼会分开处理，比如一个拿着旗帜的人物模型，其人物本身的骨骼和旗帜的骨骼会分别单独处理，最后在组装到一起形成完整的动画，这么做的目的是隔绝不同人物模型的不同骨骼数量带来的影响。动画的融合也不同于传统动画方案对模型骨骼做插值，而是在GPU端的着色阶段，对源动画和目标动画对应的蒙皮顶点进行插值，这样可以直接省去存储融合动画姿势的空间。

Dong等人在2019年提出了一种实现大型动画人群高效渲染的方案，可以有效管理多种类型的人群在CPU上的数据组织，且利用了连续LoD技术既加速了渲染效率，又不会损失渲染的质量。Dong等人的方案也是在分离了CPU和GPU的工作，让它们做各自最“擅长”的事情。CPU端会将模型的骨骼、蒙皮权重、顶点发现、纹理信息、动画信息以及包围球信息传入到GPU的全局内存中，在GPU中以流水线的方式渲染模型动画。首先就是视锥体剔除阶段，会根据模型的包围盒信息剔除掉相机视野以外的模型。然后进入到LoD选择阶段，此阶段模型会根据Lod Selection算法决定最终要渲染的顶点数量，该权重的值取决与模型的包围球在场景中的投影面积、模型包围球在裁剪空间的深度以及一个可控的参数。然后模型就进入网格重构阶段，该阶段的主要目的是为上一个阶段更新了新LoD顶点数量的模型设置正确的纹理坐标。最后阶段根据GPU端的实例化技术将模型渲染出来。
### 1.3 研究内容和主要工作  
#### 1.3.1 研究内容  
#### 1.3.2 主要工作  
### 1.4 本文组织架构  
### 1.5 本章小结  
## 第2章 关键技术综述  
### 2.1 骨骼动画基础  
本文研究的重点是基于骨骼动画的大规模群体动画渲染系统，因此，本小节将介绍骨骼动画的基础知识，包括骨骼动画的实现原理以及现有方案中最常见的骨骼动画实现技术。
#### 2.1.1 骨骼动画原理
从实现来说，计算机动画可以分为以下几类，赛璐璐动画、刚性层级动画、每顶点动画、形变目标动画和蒙皮动画。赛璐璐动画是经典的传统动画，也称手绘动画，顾名思义，这种动画模式就是把动画的每一帧绘制存储下来，在需要的时候，将存储的动画序列连续绘制出来，通常2D游戏的动画就是这样实现的，它也有个等价的名字，精灵动画。刚性层级动画就是将模型看成若干刚体的组合，这些刚体之间有层级关系和某些运动约束，这种动画方案会与蒙皮动画结合，成为本文讨论的重点——蒙皮骨骼动画。本段最后来说一下每顶点动画和形变目标动画，前者类似帧动画，就是对模型的所有网格顶点实施动画，保留所有网格顶点每一帧的位置，这是一种严重消耗内存的数据密集型动画方案，很少运用的实时游戏中，后者类似关键帧动画，它不存储每一帧的动画信息，而只存储某一些特定帧的动画信息，这些特定帧之间的动画状态就通过插值来实现，形变目标动画一般应用在人形角色脸部的动画表现。

动画通常关注的是运动的质量，而没有必要把控模型每个点每一帧精确的位置和朝向，得益于机器人运动的方法，我们可以将模型看成是若干刚体的约束组合，这些层级关系可以用树这种数据结构来表示，在制作动画时，动画师只需要关注模型关键位置的运动质量，剩余的运动细节可以由模型本身的约束来实现。这些关键位置通常是刚体和刚体之间的链接处，因此我们可以把模型进一步抽象，不再看成刚体之间的层级关系，而是看成刚体与刚体之间连接点的层级关系。当然，在实际环境中，我们还需要考虑物理规律的影响，所以有时候需要动画施加强制行为，如强制执行非穿透约束、计算重力及其他力的影响等等。运动就是通过模型的约束混和自然规则以及用户提供的附加控制信息组合产生的。

分层建模是是在树状结构中组织的对象之间强制执行连通性（或相对位置）约束的过程。举例来说，一个典型的人物模型可以被拆分为骨盆、躯干、上臂、下臂、大腿、小腿、手、脚和头，这些部位以具有层次结构的方式相互限制，类似人的骨骼在关节处的连接方式，这种模型约束是和自然现象类似的，例如上臂的运动会带动下臂和手的运动。在计算机图形学中，我们主要关注的是层级连接处（也称为关节）的运动，关节可运动的维度个数称为自由度（DoF），自由度超过1的关节称为复杂关节，复杂关节可以分为球窝关节（用于旋转）和平面关节（用于移动）。例如，如果某个关节既可以沿着x轴平移又可以绕着y轴旋转，那么这个关节的自由度就2。最后在来说一下分层建模和树形结构的映射关系，以人物模型为例，上文将人物模型分拆成了盆骨、躯干等部分，在人物图形上，关节存在于各个拆分部分之间的连接处，但在树结构中，关节是各个拆分部分节点之间的连接关系，这样做看似不够直观，但是却很方便，因为一个树节点（即一个对象部分）可能有几个连接到它的关节。

由前文我们知道，一个模型可以建模成一个树形分层模型，对这个树形结构进行深度递归便利，通过父节点的坐标空间信息计算子节点的空间坐标信息，这个就是正向运动学。下文会阐述如何利用正向运动学实现模型的动画。
在模型的分层结构中，子层级的空间坐标是相对父层级的空间坐标而言的，对应到树结构，各个树节点（除根节点外）存储的空间坐标都是局部坐标，需要经过一系列的“模型变换矩阵”才能得到世界坐标。为了搞清楚这点，先引入几个概念。动画是由模型的连续不同的动画帧组成的，每帧动画对应的关节空间位置都不一样，一个模型在某一个帧的所有关节位置集合叫做一个姿势，一个分层模型的动画就是由这些不同的姿势排列而成的。姿势存储了所有关节的局部空间信息，在一个动画上取两个不同的姿势，对这两个不同姿势的相同关节做插值操作，就能得到这两个姿势的中间姿势，这也是后续动画融合和动画过渡经常会用到的手段。

前面介绍了正向运动学是通过姿势的局部坐标计算得到姿势的全局坐标，而所谓反向运动学（Inverse Kinematics，IK）刚好与这相反，在反向运动学中，我们给定一个期望目标姿势（或姿势某个或某些关节）的全局坐标，要求反向求解目标姿势其他关节的局部坐标。从数学上讲，IK问题是一个误差最小化问题，假设一个姿势的末端关节由其上级n个关节决定，我们赋予这个n个关节所有可能的坐标并计算得这个末端关节的坐标，求计算所得的坐标与该末端关节的目标坐标之间的距离，这个距离越小，说明的IK的效果越好。这个求解结果可能有一个解，可能有多个解，也可能无解。无解的情况说明关节末端无法抵达到目标坐标，如远离模型的某个门把手。IK解算的方法可以归纳为4类，分别是解析法、数值法、数据驱动法和混合法，具体选择那种方法要根据计算性能以及动作平滑性来具体决定。

上文重点介绍了分层模型动画，在实际应用中也称为骨骼动画，但模型除了拥有骨骼之外，还有“皮肤”，好在有办法在确定姿势后正确地渲染模型的“皮肤”，这个过程就是蒙皮。通过观察可知，模型皮肤的网格顶点其实只受某些特定关节的影响，如头部的皮肤只受头部骨骼的影响，而手部的关节和脚步的关节等其他关节是不会影戏头部网格顶点的，事实也正是如此。简单起见，我们只考虑单个关节和单个蒙皮顶点，即假设蒙皮顶点的坐标仅受到关节的影响，再假设为顶点在关节坐标空间下的坐标，这个坐标是不变的，那么我们就可以得到蒙皮顶点在姿势P下的模型空间坐标是， 其中是当前姿势关节的关节空间到模型空间的变换矩阵。再复杂一点的情况，即一个蒙皮顶点受到多个关节的影响，那最终蒙皮顶点的坐标就是这些关节影响的加权和：。
#### 2.1.2 动画状态机  
### 2.2 高效动画渲染技术  
#### 2.2.1 LOD选择
#### 2.2.2 基于边坍缩的三角形简化  
#### 2.2.3 动画的实例化渲染  
### 2.3 当前动画渲染技术的限制  
### 2.4 本章小结  
## 第3章 基于状态共享的动画状态机模型  
### 3.1 基于状态共享的动画状态机模型的框架  
### 3.2 基于状态共享的动画状态机模型的设计
### 3.3 在Unity中实现基于状态共享的动画状态机模型  
### 3.4 本章小结  
## 第4章 基于连续LoD的动画渲染模型  
### 4.1 连续LoD模型的改进和应用  
### 4.2 动画渲染实例化管理  
### 4.3 基于Unity引擎实现动画的GPU渲染  
### 4.4 本章小结  
## 第5章 大规模群体动画渲染系统的设计与实现  
### 5.1 大规模群体动画渲染系统框架
### 5.2 在CPU端实现动画状态共享
### 5.3 在GPU端实现动画渲染  
### 5.4 本章小结  
## 第6章 实时大规模群体动画渲染系统的测试与性能分析  
### 6.1 项目背景
### 6.2 当前项目的动画渲染瓶颈
### 6.3 当前项目动画性能和改进方案后动画性能的对比  
### 6.4 动画性能总结分析  
### 6.5 本章小结
## 第7章 总结与展望  
### 7.1 总结  
### 7.2 展望  
## 参考文献
## 作者经历
## 致谢
